<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>USYD Meta Lab • Experiments</title>
  <meta name="description" content="Catalog of experiments from USYD Meta Lab" />
  <style>
    :root {
      --bg: #ffffff;
      --fg: #0f172a;
      --muted: #475569;
      --border: #e5e7eb;
      --chip: #eef2ff;
      --accent: #1e40af;
      --accent-muted: #dbeafe;
      --radius: 14px;
      --space: 14px;
      --maxw: 1100px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Apple Color Emoji, Segoe UI Emoji;
      background: var(--bg); color: var(--fg);
    }
    header {
      border-bottom: 1px solid var(--border);
      position: sticky; top: 0; backdrop-filter: blur(6px); background: rgba(255,255,255,.8);
    }
    .wrap { max-width: var(--maxw); margin: 0 auto; padding: 18px var(--space); }
    .title { display:flex; gap:10px; align-items:center; }
    .title h1 { font-size: 22px; margin: 0; }
    .title small { color: var(--muted); }
    .title .spacer { flex: 1 1 auto; }

    /* Controls */
    .controls { display:grid; gap: 10px; grid-template-columns: 2fr 1fr 1fr 1fr; align-items:end; margin-top: 12px; }
    @media (max-width: 900px){ .controls{ grid-template-columns: 1fr 1fr; } }
    @media (max-width: 520px){ .controls{ grid-template-columns: 1fr; } }
    label { display:block; font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    input[type="search"], select {
      width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 10px; background: #fff;
    }
    .chips { display:flex; flex-wrap: wrap; gap:6px; margin-top: 6px; }
    .chip { display:inline-flex; align-items:center; gap:6px; padding: 4px 8px; border-radius: 999px; background: var(--chip); border: 1px solid var(--border); font-size: 12px; }
    .chip button { border: 0; background: transparent; cursor: pointer; color: var(--muted); font-size: 14px; }

    /* Cards */
    .grid { display:grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-top: 16px; }
    @media (max-width: 1100px){ .grid{ grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 680px){ .grid{ grid-template-columns: 1fr; } }
    .card {
      border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; background: #fff;
      display:flex; flex-direction: column; gap: 8px;
    }
    .card h3 { margin: 0; font-size: 18px; line-height: 1.25; }
    .proj-title { margin: 0; font-size: 18px; line-height: 1.25; }
    .exp-title { margin: 0; font-size: 14px; color: var(--muted); line-height: 1.3; }
    .meta { font-size: 13px; color: var(--muted); display:flex; gap: 10px; flex-wrap: wrap; }
    /*
    .status-active { color: #166534; font-weight: 600; }    / green /
    .status-draft { color: #92400e; font-weight: 600; }     / orange/brown /
    .status-archived { color: #991b1b; font-weight: 600; }  / red /
    .status-pilot { color: #1d4ed8; font-weight: 600; }     / blue /
    */
    /* Apple-like subtle tints & gentle elevation */
    .card { transition: transform 120ms ease, box-shadow 180ms ease, border-color 180ms ease; box-shadow: 0 1px 2px rgba(0,0,0,0.03); }
    .card:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,0.08); border-color: #d1d5db; }

    .card-active  { background: linear-gradient(180deg, #f7fbf9 0%, #ffffff 100%); border-color: #d9efe6; }
    .card-draft   { background: linear-gradient(180deg, #fffaf2 0%, #ffffff 100%); border-color: #f1e3c7; }
    .card-archived{ background: linear-gradient(180deg, #fdf6f6 0%, #ffffff 100%); border-color: #f0d3d3; }
    .card-pilot   { background: linear-gradient(180deg, #f6f9ff 0%, #ffffff 100%); border-color: #d6e4fb; }
    .tags { display:flex; flex-wrap: wrap; gap: 6px; margin-top: 4px; }
    .tag { background: var(--accent-muted); color: var(--accent); padding: 2px 8px; border-radius: 8px; font-size: 12px; }
    .links a { text-decoration: none; color: var(--accent); }
    .links a + a::before { content: " · "; color: var(--muted); }
    .count { color: var(--muted); font-size: 13px; margin-top: 6px; }

    .empty {
      text-align: center; color: var(--muted); padding: 48px 16px; border: 1px dashed var(--border); border-radius: var(--radius);
    }
    footer { border-top: 1px solid var(--border); margin-top: 28px; }
    .sr-only { position:absolute; left:-9999px; }

    .btn-primary:hover, .btn-primary:focus { filter: brightness(0.95); }
    .btn-icon { padding: 6px 10px; font-size: 16px; }
    .actions { margin-top: 8px; display: flex; gap: 6px; }
    .btn { display: inline-block; padding: 8px 12px; border-radius: 10px; border: 1px solid var(--accent); text-decoration: none; font-weight: 600; }
    .btn-primary { background: var(--accent); color: #ffffff; }
    .btn-ghost { background: #ffffff; color: var(--accent); border-color: var(--border); }

    /* Minimalist icon buttons (Apple-like) */
    .iconbtn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 34px;
      height: 34px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,0.08);
      background: rgba(0,0,0,0.03);
      color: #0f172a;
      text-decoration: none;
      transition: transform 120ms ease, box-shadow 180ms ease, background 120ms ease, border-color 180ms ease;
      box-shadow: 0 1px 2px rgba(0,0,0,0.04);
    }
    .iconbtn:hover, .iconbtn:focus {
      transform: translateY(-1px);
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
      background: rgba(0,0,0,0.05);
      border-color: rgba(0,0,0,0.12);
      outline: none;
    }
    .iconbtn svg { width: 18px; height: 18px; display:block; }

    /* New experiment button */
    .ml-auto { margin-left: auto; }
    .new-exp {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #ffffff;
      color: var(--fg);
      text-decoration: none;
      font-weight: 600;
      transition: transform 120ms ease, box-shadow 180ms ease, background 120ms ease, border-color 180ms ease;
      box-shadow: 0 1px 2px rgba(0,0,0,0.04);
    }
    .new-exp:hover, .new-exp:focus {
      transform: translateY(-1px);
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
      background: rgba(0,0,0,0.02);
      border-color: rgba(0,0,0,0.12);
      outline: none;
    }
    .new-exp svg { width: 16px; height: 16px; display:block; }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="title">
        <img src="https://usyd-meta-lab.github.io/images/logo.PNG" alt="USYD Meta Lab Logo" style="height:40px;">
        <h1>USYD Meta Lab — Experiments</h1>
        <small id="updated"></small>
        <button id="refresh" class="iconbtn" title="Refresh list" aria-label="Refresh list" style="margin-left:4px">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M4 12a8 8 0 0 1 13.657-5.657M20 12a8 8 0 0 1-13.657 5.657" fill="none" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/>
            <path d="M17 3v4h-4" fill="none" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/>
            <path d="M7 21v-4h4" fill="none" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/>
          </svg>
        </button>
        <a class="new-exp ml-auto" href="https://github.com/usyd-meta-lab/code/issues/new?template=new-experiment.yml&labels=new-experiment&title=%5BExperiment%5D%20" target="_blank" rel="noopener" aria-label="Create a new experiment" title="Create a new experiment">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path>
          </svg>
          <span>New experiment</span>
        </a>
      </div>

      <div class="controls" role="region" aria-label="Filters">
        <div>
          <label for="q">Search (title, description, tags)</label>
          <input id="q" type="search" placeholder="e.g., metacognition, jsPsych, MSCEIT…" />
        </div>
        <div>
          <label for="status">Status</label>
          <select id="status">
            <option value="" selected>All</option>
            <option>draft</option>
            <option>pilot</option>
            <option>active</option>
            <option>archived</option>
          </select>
        </div>
        <div>
          <label for="sort">Sort</label>
          <select id="sort">
            <option value="created_desc" selected>Newest first</option>
            <option value="created_asc">Oldest first</option>
            <option value="updated_desc">Recently updated</option>
            <option value="title_asc">Title A→Z</option>
          </select>
        </div>
        <div>
          <label for="tagInput">Tag filter (press Enter)</label>
          <input id="tagInput" type="search" placeholder="Add tag…" />
          <div id="tagChips" class="chips" aria-live="polite"></div>
        </div>
      </div>

      <div class="count" id="count">Loading…</div>
    </div>
  </header>

  <main class="wrap">
    <section id="grid" class="grid" aria-live="polite"></section>
    <div id="empty" class="empty" hidden>No experiments match your filters.</div>
  </main>

  <footer>
    <div class="wrap" style="font-size:13px;color:var(--muted);">
      Data source: <code id="src"></code>. Update your catalog in GitHub and this page will auto-reflect it on next deploy.
    </div>
  </footer>

  <script>
    // ─────────────────────────────────────────────────────────────────────────────
    // CONFIG: If experiments.json is on the SAME site, set to '/experiments.json'.
    // Otherwise, point to your Pages URL, e.g.:
    // 'https://usyd-meta-lab.github.io/experiments/experiments.json'
    const CATALOG_URL = 'https://usyd-meta-lab.github.io/code/experiments/experiments.json'; // relative to this page (works on GitHub Pages repo paths)
    // ─────────────────────────────────────────────────────────────────────────────

    const els = {
      grid: document.getElementById('grid'),
      empty: document.getElementById('empty'),
      q: document.getElementById('q'),
      status: document.getElementById('status'),
      sort: document.getElementById('sort'),
      count: document.getElementById('count'),
      updated: document.getElementById('updated'),
      src: document.getElementById('src'),
      tagInput: document.getElementById('tagInput'),
      tagChips: document.getElementById('tagChips'),
      refresh: document.getElementById('refresh'),
    };

    let DATA = [];
    let TAGS = [];

    function normalize(x){ return (x ?? '').toString().toLowerCase(); }

    function recordMatches(r){
      const q = normalize(els.q.value);
      const stat = els.status.value;
      const hasStatus = !stat || (r.status === stat);

      const tagOk = TAGS.length === 0 || (Array.isArray(r.tags) && TAGS.every(t => r.tags.map(normalize).includes(normalize(t))));

      const hay = [
        r.id, r.title, r.short_title, r.project_title, r.description,
        ...(r.tags || []), ...(r.authors || [])
      ].map(normalize).join(' ');
      const qOk = !q || hay.includes(q);

      return hasStatus && tagOk && qOk;
    }

    function sortRecords(list){
      const mode = els.sort.value;
      const byDate = (k, dir=-1) => (a,b)=> (normalize(b[k])>normalize(a[k])?1:-1)*dir;
      const byTitle = (a,b)=> normalize(a.title).localeCompare(normalize(b.title));
      if(mode==='created_asc') return list.sort(byDate('date_created', +1));
      if(mode==='updated_desc') return list.sort(byDate('date_updated', -1));
      if(mode==='title_asc') return list.sort(byTitle);
      return list.sort(byDate('date_created', -1));
    }

    function render(){
      const items = sortRecords(DATA.filter(recordMatches));
      els.count.textContent = items.length
        ? `${items.length} experiment${items.length===1?'':'s'}`
        : '0 experiments';

      if(items.length === 0){
        els.grid.innerHTML = '';
        els.empty.hidden = false;
        return;
      }
      els.empty.hidden = true;
      els.grid.innerHTML = items.map(r => card(r)).join('');
    }

    const chip = (t,i)=> `<span class="chip">${t}<button aria-label="Remove ${t}" onclick="removeTag(${i})">✕</button></span>`;
    function refreshChips(){
      els.tagChips.innerHTML = TAGS.map((t,i)=>chip(t,i)).join('');
    }
    function removeTag(i){ TAGS.splice(i,1); refreshChips(); render(); }
    function addTagFromInput(){
      const v = els.tagInput.value.trim();
      if(v && !TAGS.includes(v)){ TAGS.push(v); refreshChips(); render(); }
      els.tagInput.value = '';
    }

    function card(x){
      const projectTitle = x.project_title || '';
      const experimentTitle = x.title || x.short_title || x.id;
      const desc = x.description || '';
      const tags = (x.tags || []).map(t => `<span class="tag">${t}</span>`).join('');
      const links = [
        x?.links?.github ? `<a href="${x.links.github}" target="_blank" rel="noopener">Code</a>` : '',
        x?.links?.osf ? `<a href="${x.links.osf}" target="_blank" rel="noopener">OSF</a>` : '',
        x?.links?.prereg ? `<a href="${x.links.prereg}" target="_blank" rel="noopener">Prereg</a>` : ''
      ].filter(Boolean).join('');

      const created = x.date_created || '';
      const updated = x.date_updated ? ` · Updated: ${x.date_updated}` : '';

      const titleBlock = `
        <div>
          ${projectTitle
            ? `<div class=\"proj-title\">${escapeHTML(projectTitle)}</div><div class=\"exp-title\">${escapeHTML(experimentTitle)}</div>`
            : `<div class=\"proj-title\">${escapeHTML(experimentTitle)}</div>`}
        </div>`;

      const titleLinked = (
        x?.links?.live
          ? `<a href="${x.links.live}" target="_blank" rel="noopener" aria-label="Open experiment">${titleBlock}</a>`
          : (x?.links?.github
              ? `<a href="${x.links.github}" target="_blank" rel="noopener" aria-label="Open repository">${titleBlock}</a>`
              : titleBlock)
      );

      return `
        <article class="card card-${escapeHTML((x.status||'').toLowerCase())}">
          ${titleLinked}
          <div class="meta">
            Status: ${escapeHTML(x.status || '—')}
            · Created: ${escapeHTML(created)}${updated}
          </div>
          ${desc ? `<p>${escapeHTML(desc)}</p>` : ''}
          ${tags ? `<div class="tags">${tags}</div>` : ''}
          ${links ? `<div class="links">${links}</div>` : ''}
          <div class="actions">
            <!-- Start study: play-in-circle (thin stroke, monochrome) -->
            <a class="iconbtn" href="https://usyd-meta-lab.github.io/code/experiments/${escapeHTML(x.id)}/" target="_blank" rel="noopener" aria-label="Start study" title="Start study">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <circle cx="12" cy="12" r="9.25" fill="none" stroke="currentColor" stroke-width="1.2"></circle>
                <path d="M10 8l6 4-6 4z" fill="currentColor"></path>
              </svg>
            </a>
            <!-- Open repository folder: minimal folder outline (thin stroke) -->
            <a class="iconbtn" href="https://github.com/usyd-meta-lab/code/tree/main/experiments/${escapeHTML(x.id)}/" target="_blank" rel="noopener" aria-label="Open folder in repository" title="Open folder in repository">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M3.5 7.5h5.5l2 2H20a1.5 1.5 0 0 1 1.5 1.5v7A1.5 1.5 0 0 1 20 19.5H4.5A1.5 1.5 0 0 1 3 18V9a1.5 1.5 0 0 1 1.5-1.5z" fill="none" stroke="currentColor" stroke-width="1.2" stroke-linejoin="round" stroke-linecap="round"></path>
              </svg>
            </a>
          </div>
        </article>
      `;
    }

    function escapeHTML(s){
      return (s??'').toString()
        .replaceAll('&','&amp;').replaceAll('<','&lt;')
        .replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#39;");
    }

    async function init(){
      els.src.textContent = CATALOG_URL;
      try{
        const res = await fetch(CATALOG_URL, { cache: 'no-store' });
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const json = await res.json();
        DATA = Array.isArray(json) ? json : [];
        // Derive "last updated" display from max(date_updated/date_created)
        const dates = DATA.map(r => r.date_updated || r.date_created).filter(Boolean).sort().reverse();
        if(dates[0]) els.updated.textContent = `Updated: ${dates[0]}`;
        render();
      }catch(err){
        els.count.textContent = 'Could not load catalog.';
        els.grid.innerHTML = '';
        els.empty.hidden = false;
        els.empty.textContent = `Failed to load ${CATALOG_URL}. Check that your GitHub Action published experiments.json.`;
        console.error(err);
      }
    }

    // Wire up events
    els.q.addEventListener('input', render);
    els.status.addEventListener('change', render);
    els.sort.addEventListener('change', render);
    els.tagInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); addTagFromInput(); } });
    els.refresh.addEventListener('click', (e)=>{ e.preventDefault(); init(); });

    // Allow setting catalog via URL ?src=
    (function overrideFromQuery(){
      const url = new URL(window.location);
      const src = url.searchParams.get('src');
      if(src){ window.CATALOG_URL = src; }
    })();

    init();
  </script>

  <noscript>
    <div class="wrap" style="margin-top:20px;color:#b91c1c">
      This page requires JavaScript to fetch and display the experiment catalog.
    </div>
  </noscript>
</body>
</html>
